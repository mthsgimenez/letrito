import Jimp from "jimp";

async function controller(req, res) {
   const artist = req.body.artist;
   const song = req.body.song;
   const verses = req.body.verses;
   const coverArt = req.body.coverArt;

   if (artist == undefined || song == undefined || verses.length < 1 || coverArt == undefined) {
      res.send("Invalid");
   }

   const image = await generateImage(song, artist, verses, "#cac9e2", coverArt);
   res.type("png");
   res.attachment(image);
   res.download(image);
}

/**
* Searches genius.com and returns an array of results
* @param {string} song - Song name
* @param {string} artist - Artist name
* @param {Array.string} verses - Array of strings containing the selected verses
* @param {string} color - Background color for the image in hexadecimal
* @param {string} coverArt - Url to a cover art
* @returns {string} path - Path on the filesystem to the generated image
*/
async function generateImage(song, artist, verses, color, coverArt) {
   const image = new Jimp(800, 800, color);

   const coverArtSize = 85;
   const padding = 15;

   const coverPromise = await Jimp.read(coverArt);
   const maskPromise = await Jimp.read("./src/resources/mask.png");
   const boldFontPromise = await Jimp.loadFont("./src/resources/InterBoldBlack.fnt");
   const regularFontPromise = await Jimp.loadFont("./src/resources/InterRegularBlack.fnt");

   const [cover, mask, boldFont, regularFont] = await Promise.all([coverPromise, maskPromise, boldFontPromise, regularFontPromise]);

   const width = Jimp.measureText(boldFont, ((artist.length >= song) ? artist : song)) + padding * 2 + coverArtSize;
   const maxWidth = width - padding;
   if (width < 600) {
      width = 600 + padding;
      maxWidth = 600;
   }
   const boldCharHeight = Jimp.measureTextHeight(boldFont, "A", width);

   let verseHeight = 0;
   let y = coverArtSize + boldCharHeight * 2;
   for (let verse of verses) {
      image.print(boldFont, padding, y, verse, maxWidth);
      verseHeight = Jimp.measureTextHeight(boldFont, verse, maxWidth);
      if (verseHeight > boldCharHeight) {
         y += verseHeight + 5;
      } else {
         y += boldCharHeight + 6;
      }
   }

   image.print(boldFont, padding * 2 + coverArtSize, boldCharHeight, song);
   image.print(regularFont, padding * 2 + coverArtSize, boldCharHeight * 2, artist);

   cover.resize(coverArtSize, coverArtSize);
   cover.mask(mask, 0, 0);

   image.composite(cover, padding, padding);

   image.crop(0, 0, width + padding * 3, y + padding);

   const path = "./src/public/img/" + Date.now() + ".png";
   await image.writeAsync(path);

   return path;
}

export default controller;
